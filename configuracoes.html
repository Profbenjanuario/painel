<!-- configuracoes.html -->
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Configura√ß√µes - Sistema Vanda</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <style>
    :root {
      --cor-primaria: #667eea;
      --cor-secundaria: #764ba2;
      --fundo-gradiente: linear-gradient(135deg, var(--cor-primaria), var(--cor-secundaria));
    }
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', system-ui, sans-serif; }
    body { background: var(--fundo-gradiente); color: #333; min-height: 100vh; }
    .container { max-width: 1000px; margin: 0 auto; padding: 20px; }
    header { background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); padding: 15px 30px; border-radius: 15px; margin-bottom: 30px; box-shadow: 0 8px 32px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
    .logo { font-size: 24px; font-weight: bold; color: var(--cor-primaria); display: flex; align-items: center; gap: 10px; }
    .btn { padding: 10px 20px; border: none; border-radius: 25px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; text-decoration: none; display: inline-flex; align-items: center; gap: 8px; }
    .btn-secondary { background: #f8f9fa; color: var(--cor-primaria); border: 2px solid var(--cor-primaria); }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
    .card { background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); border-radius: 20px; padding: 30px; box-shadow: 0 8px 32px rgba(0,0,0,0.1); margin-bottom: 25px; }
    .card-title { font-size: 20px; font-weight: 600; margin-bottom: 20px; color: #333; display: flex; align-items: center; gap: 10px; }
    .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px,1fr)); gap: 20px; }
    .form-group { margin-bottom: 20px; }
    .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; }
    .form-group input,
    .form-group textarea,
    .form-group select { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; transition: all 0.3s ease; }
    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus { outline: none; border-color: var(--cor-primaria); box-shadow: 0 0 0 3px rgba(102,126,234,0.1); }
    .color-preview { display: inline-block; width: 30px; height: 30px; border-radius: 50%; margin-left: 10px; vertical-align: middle; border: 2px solid white; box-shadow: 0 0 4px rgba(0,0,0,0.3); }
    .btn-group { display: flex; gap: 15px; margin-top: 20px; flex-wrap: wrap; }
    .status-box { padding: 15px; border-radius: 10px; margin-top: 20px; font-weight: 600; }
    .status-success { background: rgba(40,167,69,0.1); color: #155724; }
    .status-error { background: rgba(220,53,69,0.1); color: #721c24; }
    .preview-theme { margin-top: 20px; padding: 15px; background: white; border-radius: 10px; text-align: center; }
    @media (max-width: 768px) {
      .form-grid { grid-template-columns: 1fr; }
      header { flex-direction: column; gap: 15px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo">
        <i class="fas fa-cog"></i>
        Configura√ß√µes do Sistema
      </div>
      <a href="index.html" class="btn btn-secondary">
        <i class="fas fa-arrow-left"></i> Voltar
      </a>
    </header>

    <div class="card">
      <h2 class="card-title"><i class="fas fa-plug"></i> Conex√£o com Google Sheets</h2>
      <div class="form-grid">
        <div class="form-group">
          <label for="urlGas">URL do Web App (GAS)</label>
          <input type="text" id="urlGas" placeholder="Digita o Link do GAS"/>
        </div>
        <div class="form-group">
          <label for="spreadsheetId">ID da Planilha</label>
          <input type="text" id="spreadsheetId" placeholder="Digita o ID da Planilha"/>
        </div>
      </div>
      <div class="btn-group">
        <button type="button" class="btn btn-secondary" onclick="testarConexao()">
          <i class="fas fa-wifi"></i> Testar Conex√£o
        </button>
        <button type="button" class="btn btn-secondary" onclick="salvarConexao()">
          <i class="fas fa-save"></i> Salvar Configura√ß√£o
        </button>
      </div>
      <div id="statusConexao" class="status-box" style="display: none;"></div>
    </div>

    <div class="card">
      <h2 class="card-title"><i class="fas fa-paint-brush"></i> Identidade da Loja</h2>
      <div class="form-grid">
        <div class="form-group">
          <label for="nomeEmpresa">Nome da Empresa</label>
          <input type="text" id="nomeEmpresa" placeholder="Ex: Loja do Jo√£o" />
        </div>
        <div class="form-group">
          <label for="corPrimaria">Cor Prim√°ria
            <span id="previewPrimaria" class="color-preview"></span>
          </label>
          <input type="color" id="corPrimaria" value="#667eea" onchange="atualizarCores()" />
        </div>
        <div class="form-group">
          <label for="corSecundaria">Cor Secund√°ria
            <span id="previewSecundaria" class="color-preview"></span>
          </label>
          <input type="color" id="corSecundaria" value="#764ba2" onchange="atualizarCores()" />
        </div>
      </div>

      <div class="form-group">
        <label for="enderecoFiscal">Endere√ßo Completo</label>
        <textarea id="enderecoFiscal" rows="2" placeholder="Rua Exemplo, 123 ‚Äì Bairro, Cidade/UF"></textarea>
      </div>
      <div class="form-grid">
        <div class="form-group">
          <label for="telefone">Telefone</label>
          <input type="text" id="telefone" placeholder="(11) 99999-9999" />
        </div>
        <div class="form-group">
          <label for="email">E-mail</label>
          <input type="email" id="email" placeholder="contato@loja.com" />
        </div>
      </div>

      <div class="preview-theme">
        <p>Visualiza√ß√£o ao vivo do tema:</p>
        <div style="background: var(--fundo-gradiente); color: white; padding: 10px; border-radius: 8px; display: inline-block;">
          <i class="fas fa-store"></i> <span id="previewNome">Sua Loja</span>
        </div>
      </div>

      <div class="btn-group" style="margin-top: 20px;">
        <button type="button" class="btn btn-secondary" onclick="salvarEmpresa()">
          <i class="fas fa-save"></i> Salvar Identidade da Loja
        </button>
      </div>
    </div>
  </div>
  <script>
// script.js - API para comunica√ß√£o com Google Apps Script (VERS√ÉO CORRIGIDA)
class GoogleSheetsAPI {
    static obterConfiguracoesAtuais() {
        const padrao = {
            gas_url: '',
            spreadsheet_id: ''
        };
        const salvo = JSON.parse(localStorage.getItem('vanda_gas_config') || '{}');
        return { ...padrao, ...salvo };
    }

    static atualizarConfiguracoes(url, id) {
        const config = { gas_url: url, spreadsheet_id: id };
        localStorage.setItem('vanda_gas_config', JSON.stringify(config));
        return config;
    }

    static async testarConexao() {
        try {
            console.log('üîç Iniciando teste de conex√£o...');
            const resposta = await this.get('testarConexao', {});
            console.log('‚úÖ Resposta recebida:', resposta);
            return resposta && resposta.status === 'success';
        } catch (erro) {
            console.error('‚ùå Erro no teste:', erro);
            throw new Error('Falha na conex√£o: ' + erro.message);
        }
    }

    static async get(acao, parametros = {}) {
        return this.request(acao, parametros, 'GET');
    }

    static async request(acao, dados = {}, metodo = 'GET') {
        const config = this.obterConfiguracoesAtuais();
        
        if (!config.gas_url) {
            throw new Error('URL do GAS n√£o configurada');
        }

        const url = new URL(config.gas_url);
        url.searchParams.set('action', acao);
        url.searchParams.set('spreadsheetId', config.spreadsheet_id);

        // Para GET, adiciona par√¢metros na URL
        if (metodo === 'GET') {
            Object.keys(dados).forEach(key => {
                url.searchParams.set(key, JSON.stringify(dados[key]));
            });
        }

        console.log(`üì§ ${metodo} ${acao}:`, url.toString());

        const opcoes = {
            method: metodo,
            mode: 'cors',
            cache: 'no-cache',
            credentials: 'omit'
        };

        // S√≥ adiciona headers e body para POST (quando necess√°rio)
        if (metodo === 'POST' && Object.keys(dados).length > 0) {
            opcoes.headers = { 'Content-Type': 'application/json' };
            opcoes.body = JSON.stringify(dados);
        }

        try {
            const resposta = await fetch(url.toString(), opcoes);
            
            if (!resposta.ok) {
                throw new Error(`Erro HTTP ${resposta.status}: ${resposta.statusText}`);
            }
            
            const texto = await resposta.text();
            console.log('üì® Resposta bruta:', texto);
            
            let resultado;
            try {
                resultado = JSON.parse(texto);
            } catch (parseError) {
                throw new Error(`Resposta inv√°lida do servidor: ${texto.substring(0, 100)}`);
            }

            if (resultado.status === 'error') {
                throw new Error(resultado.message || 'Erro no servidor');
            }

            console.log(`‚úÖ ${acao} sucesso:`, resultado);
            return resultado;
        } catch (erro) {
            console.error(`‚ùå ${acao} falhou:`, erro);
            
            // Mensagem mais amig√°vel para o usu√°rio
            if (erro.message.includes('Failed to fetch') || erro.message.includes('NetworkError')) {
                throw new Error('N√£o foi poss√≠vel conectar ao servidor. Verifique sua conex√£o de internet.');
            } else if (erro.message.includes('CORS')) {
                throw new Error('Problema de seguran√ßa no servidor. Tente novamente.');
            } else {
                throw new Error(`Falha na requisi√ß√£o: ${erro.message}`);
            }
        }
    }
}

// Sistema de Notifica√ß√µes
class Notificacao {
    static mostrar(mensagem, tipo = 'info') {
        // Remove notifica√ß√£o existente
        const existente = document.getElementById('notificacao-sistema');
        if (existente) existente.remove();
        
        // Cria nova notifica√ß√£o
        const notif = document.createElement('div');
        notif.id = 'notificacao-sistema';
        notif.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 10000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            font-family: 'Segoe UI', system-ui, sans-serif;
            max-width: 400px;
            word-wrap: break-word;
        `;
        
        const cores = {
            success: '#28a745',
            error: '#dc3545', 
            warning: '#ffc107',
            info: '#17a2b8'
        };
        
        notif.style.backgroundColor = cores[tipo] || cores.info;
        notif.textContent = mensagem;
        document.body.appendChild(notif);
        
        // Remove ap√≥s 4 segundos
        setTimeout(() => {
            if (notif.parentNode) notif.parentNode.removeChild(notif);
        }, 4000);
    }
}

// Configura√ß√µes da p√°gina
document.addEventListener('DOMContentLoaded', async () => {
    console.log('üöÄ Configura√ß√µes carregando...');
    await carregarConfiguracoes();
    atualizarCores();
});

async function carregarConfiguracoes() {
    console.log('üì• Carregando configura√ß√µes salvas...');
    const configConexao = GoogleSheetsAPI.obterConfiguracoesAtuais();
    document.getElementById('urlGas').value = configConexao.gas_url;
    document.getElementById('spreadsheetId').value = configConexao.spreadsheet_id;

    try {
        console.log('üîÑ Buscando dados da empresa...');
        const resposta = await GoogleSheetsAPI.get('obterEmpresa');
        const e = resposta.data?.empresa || {};
        document.getElementById('nomeEmpresa').value = e.nome || '';
        document.getElementById('enderecoFiscal').value = e.endereco || '';
        document.getElementById('telefone').value = e.telefone || '';
        document.getElementById('email').value = e.email || '';
        if (e.corPrimaria) document.getElementById('corPrimaria').value = e.corPrimaria;
        if (e.corSecundaria) document.getElementById('corSecundaria').value = e.corSecundaria;
        atualizarCores();
        console.log('‚úÖ Dados da empresa carregados');
    } catch (ex) {
        console.warn('‚ö†Ô∏è Empresa n√£o configurada ou erro ao carregar:', ex);
    }
}

function atualizarCores() {
    const c1 = document.getElementById('corPrimaria').value;
    const c2 = document.getElementById('corSecundaria').value;
    document.documentElement.style.setProperty('--cor-primaria', c1);
    document.documentElement.style.setProperty('--cor-secundaria', c2);
    document.documentElement.style.setProperty('--fundo-gradiente', `linear-gradient(135deg, ${c1}, ${c2})`);
    document.getElementById('previewPrimaria').style.backgroundColor = c1;
    document.getElementById('previewSecundaria').style.backgroundColor = c2;
    document.getElementById('previewNome').textContent = document.getElementById('nomeEmpresa').value || 'Sua Loja';
}

async function testarConexao() {
    console.log('üéØ Bot√£o Testar Conex√£o clicado');
    
    const url = document.getElementById('urlGas').value.trim();
    const id = document.getElementById('spreadsheetId').value.trim();
    
    if (!url || !id) {
        Notificacao.mostrar('‚ùå Preencha URL e ID da planilha', 'error');
        return;
    }
    
    console.log('üíæ Salvando configura√ß√µes...');
    GoogleSheetsAPI.atualizarConfiguracoes(url, id);
    
    try {
        Notificacao.mostrar('üîç Testando conex√£o...', 'info');
        console.log('üîÑ Iniciando teste de conex√£o...');
        
        await GoogleSheetsAPI.testarConexao();
        
        mostrarStatus('‚úÖ Conex√£o bem-sucedida!', true);
        Notificacao.mostrar('‚úÖ Conex√£o com Google Sheets estabelecida!', 'success');
        console.log('üéâ Conex√£o testada com sucesso!');
        
    } catch (err) {
        console.error('üí• Erro na conex√£o:', err);
        mostrarStatus('‚ùå Falha: ' + err.message, false);
        Notificacao.mostrar('‚ùå ' + err.message, 'error');
    }
}

function mostrarStatus(msg, sucesso) {
    const el = document.getElementById('statusConexao');
    el.textContent = msg;
    el.className = 'status-box ' + (sucesso ? 'status-success' : 'status-error');
    el.style.display = 'block';
}

function salvarConexao() {
    const url = document.getElementById('urlGas').value.trim();
    const id = document.getElementById('spreadsheetId').value.trim();
    
    if (!url || !id) {
        Notificacao.mostrar('‚ùå Preencha ambos os campos', 'error');
        return;
    }
    
    GoogleSheetsAPI.atualizarConfiguracoes(url, id);
    mostrarStatus('‚úÖ Configura√ß√£o salva localmente.', true);
    Notificacao.mostrar('‚úÖ Configura√ß√µes salvas!', 'success');
}

async function salvarEmpresa() {
    const dados = {
        nome: document.getElementById('nomeEmpresa').value,
        endereco: document.getElementById('enderecoFiscal').value,
        telefone: document.getElementById('telefone').value,
        email: document.getElementById('email').value,
        corPrimaria: document.getElementById('corPrimaria').value,
        corSecundaria: document.getElementById('corSecundaria').value
    };
    
    try {
        Notificacao.mostrar('üíæ Salvando dados da empresa...', 'info');
        console.log('üîÑ Enviando dados da empresa:', dados);
        
        await GoogleSheetsAPI.request('salvarEmpresa', dados, 'POST');
        
        Notificacao.mostrar('‚úÖ Identidade da loja salva com sucesso!', 'success');
        localStorage.setItem('vanda_empresa', JSON.stringify(dados));
        console.log('üéâ Dados da empresa salvos!');
        
    } catch (err) {
        console.error('üí• Erro ao salvar empresa:', err);
        Notificacao.mostrar('‚ùå Erro: ' + err.message, 'error');
    }
}
</script>
  
  <script>
    // Classe de Notifica√ß√£o (adicionada diretamente aqui para garantir funcionamento)
    class Notificacao {
      static mostrar(mensagem, tipo = 'info') {
        const existente = document.getElementById('notificacao-sistema');
        if (existente) existente.remove();
        const notif = document.createElement('div');
        notif.id = 'notificacao-sistema';
        notif.style.cssText = `position: fixed; top: 20px; right: 20px; padding: 12px 20px; border-radius: 8px; color: white; font-weight: 500; z-index: 10000; box-shadow: 0 4px 12px rgba(0,0,0,0.2);`;
        const cores = { success: '#28a745', error: '#dc3545', warning: '#ffc107', info: '#17a2b8' };
        notif.style.backgroundColor = cores[tipo] || cores.info;
        notif.textContent = mensagem;
        document.body.appendChild(notif);
        setTimeout(() => { if (notif.parentNode) notif.parentNode.removeChild(notif); }, 3000);
      }
    }

    document.addEventListener('DOMContentLoaded', async () => {
      await carregarConfiguracoes();
      atualizarCores();
    });

    async function carregarConfiguracoes() {
      const configConexao = GoogleSheetsAPI.obterConfiguracoesAtuais();
      document.getElementById('urlGas').value = configConexao.gas_url;
      document.getElementById('spreadsheetId').value = configConexao.spreadsheet_id;

      try {
        const resposta = await GoogleSheetsAPI.get('obterEmpresa');
        const e = resposta.empresa || {};
        document.getElementById('nomeEmpresa').value = e.nome || '';
        document.getElementById('enderecoFiscal').value = e.endereco || '';
        document.getElementById('telefone').value = e.telefone || '';
        document.getElementById('email').value = e.email || '';
        if (e.corPrimaria) document.getElementById('corPrimaria').value = e.corPrimaria;
        if (e.corSecundaria) document.getElementById('corSecundaria').value = e.corSecundaria;
        atualizarCores();
      } catch (ex) {
        console.warn('Empresa n√£o configurada');
      }
    }

    function atualizarCores() {
      const c1 = document.getElementById('corPrimaria').value;
      const c2 = document.getElementById('corSecundaria').value;
      document.documentElement.style.setProperty('--cor-primaria', c1);
      document.documentElement.style.setProperty('--cor-secundaria', c2);
      document.documentElement.style.setProperty('--fundo-gradiente', `linear-gradient(135deg, ${c1}, ${c2})`);
      document.getElementById('previewPrimaria').style.backgroundColor = c1;
      document.getElementById('previewSecundaria').style.backgroundColor = c2;
      document.getElementById('previewNome').textContent = document.getElementById('nomeEmpresa').value || 'Sua Loja';
    }

    async function testarConexao() {
      const url = document.getElementById('urlGas').value.trim();
      const id = document.getElementById('spreadsheetId').value.trim();
      if (!url || !id) return Notificacao.mostrar('Preencha URL e ID da planilha', 'error');
      GoogleSheetsAPI.atualizarConfiguracoes(url, id);
      try {
        await GoogleSheetsAPI.testarConexao();
        mostrarStatus('‚úÖ Conex√£o bem-sucedida!', true);
      } catch (err) {
        mostrarStatus('‚ùå Falha: ' + err.message, false);
      }
    }

    function mostrarStatus(msg, sucesso) {
      const el = document.getElementById('statusConexao');
      el.textContent = msg;
      el.className = 'status-box ' + (sucesso ? 'status-success' : 'status-error');
      el.style.display = 'block';
    }

    function salvarConexao() {
      const url = document.getElementById('urlGas').value.trim();
      const id = document.getElementById('spreadsheetId').value.trim();
      if (!url || !id) return alert('Preencha ambos os campos.');
      GoogleSheetsAPI.atualizarConfiguracoes(url, id);
      mostrarStatus('‚úÖ Configura√ß√£o salva localmente.', true);
    }

    async function salvarEmpresa() {
      const dados = {
        nome: document.getElementById('nomeEmpresa').value,
        endereco: document.getElementById('enderecoFiscal').value,
        telefone: document.getElementById('telefone').value,
        email: document.getElementById('email').value,
        corPrimaria: document.getElementById('corPrimaria').value,
        corSecundaria: document.getElementById('corSecundaria').value
      };
      try {
        await GoogleSheetsAPI.request('salvarEmpresa', dados);
        Notificacao.mostrar('‚úÖ Identidade salva com sucesso!', 'success');
        localStorage.setItem('vanda_empresa', JSON.stringify(dados));
      } catch (err) {
        Notificacao.mostrar('‚ùå Erro: ' + err.message, 'error');
      }
    }
  </script>
</body>
</html>
